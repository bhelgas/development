
<!DOCTYPE html>
<html>
<head>
    <title>Image Upload and Comments</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        img {aspect-ratio: 1/1; height: 15rem; object-fit: cover;}
    </style>
</head>
<body>
    <header>
        <h1 class="largeScale down">Image Gallery</h1>
    </header>
    <section class="fileUpload">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#890a49" fill-opacity="1" d="M0,96L48,90.7C96,85,192,75,288,90.7C384,107,480,149,576,160C672,171,768,149,864,133.3C960,117,1056,107,1152,117.3C1248,128,1344,160,1392,176L1440,192L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>
        <div class="upload">
            <h1 class="largeScale up">Upload an image</h1>
            <input type="file" id="imageUpload" accept="image/*">
            <button id="uploadButton">Upload</button>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#890a49" fill-opacity="1" d="M0,256L40,240C80,224,160,192,240,197.3C320,203,400,245,480,234.7C560,224,640,160,720,133.3C800,107,880,117,960,112C1040,107,1120,85,1200,117.3C1280,149,1360,235,1400,277.3L1440,320L1440,320L1400,320C1360,320,1280,320,1200,320C1120,320,1040,320,960,320C880,320,800,320,720,320C640,320,560,320,480,320C400,320,320,320,240,320C160,320,80,320,40,320L0,320Z"></path></svg>
    </section>
    <main id="imagesContainer">
    </main>
    <div id="addComment"></div>





    <script type="module">
        // Import required modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getStorage, uploadBytes, getDownloadURL, ref } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";
        import { getFirestore, addDoc, getDoc, setDoc, collection, doc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            /*Absolutely not.*/
        };

        // Initialize application 
        const firebase = initializeApp(firebaseConfig);
        const db = getFirestore(firebase);
        const storage = getStorage();

        // Defining variables
        const imageUpload = document.getElementById('imageUpload');
        const uploadButton = document.getElementById('uploadButton');
        const imagesContainer = document.getElementById('imagesContainer');
        const commentInput = document.getElementById('commentInput');
        const addCommentButton = document.getElementById('addCommentButton');

        // Upload Image
        uploadButton.addEventListener('click', async() => {
            try {
                const file = imageUpload.files[0]; // Get file
                const fileName = file.name; // Get file name
                const getStorageRef = ref(storage, 'images/' + fileName); // Path to where you want to save your image
                uploadBytes(getStorageRef, file); // Upload file to Cloud Storage
                const getStorageUrl = await getDownloadURL(getStorageRef); // Get download URL for the image
                await setDoc(doc(db, 'images/', fileName), { // Add document to Firebase Firestore
                    imageUrl: getStorageUrl, 
                    name: fileName,
                    comments: []
                })
                console.log("Image and data uploaded!"); // Confirmation that the data has been successfully uploaded
                displayImages(); // This will display the newly uploaded image.
            } catch (error) {
                console.log("Error uploading image: " + error); // Error handling, show error message if something goes wrong
            } 
        });

        async function displayImages() {
            imagesContainer.innerHTML = ''; // Clear current image container

            await getDocs(collection(db, 'images')).then((snapshot) => { // Get document from Firebase Firestore
                snapshot.docs.forEach((doc) => { // Foreach - What will happen to each document 
                    const imageData = doc.data(); // Get image data. 
                    renderImage(doc.id, imageData.imageUrl, imageData.comments); // Call function to render Images with the data
                }) .then(() => {
                    console.log(`The images has been rendered.`); // Not needed, does not work
                }) .catch(() => { 
                    console.log("Error displaying/getting image: " + error);  // Error handling, show error message if something goes wrong.. always.
                })
            })
        }
        
        
        

        
        // Render image
        function renderImage(imageId, imageUrl, comments) { 
           imagesContainer.innerHTML += 
            `
            <div class="image">
                <img src="${imageUrl}">
                Comments: ${comments}
                <div id="commentForm">
                    <input type="text" id="commentInput" placeholder="Add a comment...">
                    <br><br><button onclick="addComment('${imageId}')">Comment</button>
                </div>
            </div>
            
           `
        }

        // Add comments function
        async function addComment(comment_ImageID) {
            const imageRef = collection(db, 'images/', comment_ImageID); // Path to image
            db.runTransaction(async (transaction) => {
                const imageDoc = await transaction.get(imageRef); // Specificying document which will be used in the transaction
                const existingComments = imageDoc.data().comments.slice(); // Get the already existing data.

                if(!imageDoc.exists) {
                    console.error("Image does not exist.") // Throwing a ne// Add comments function w error if the image specified does not exist. 
                }
                existingComments.push(commentText); // Push the data to the array in the database.
                console.log("pushed.")

                transaction.update(imageRef, { comments: existingComments }); // Finishing the transaction by adding the current array to the database

            }) .then(() => {
                console.log("Comment successfully uploaded to database!"); // I dont need to say anything
            }) .catch((error) => {
                console.log("Could not add comment to database: " + error) // Not here either
            })
        };

        export { addComment }; 
        displayImages();
    </script> 

    <script>
        import { addComment } from "./commenting.html"
        async function addComment(comment_ImageID) {
            console.log("dsgfhjioøodsghjiø")
        };
    </script>
</body>
</html>